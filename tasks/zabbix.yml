---
- name: Open Zabbix Agent2 port in firewalld
  ansible.builtin.firewalld:
    port: "{{ zabbix_agent_port }}/tcp"
    permanent: true
    immediate: yes
    zone: "{{ firewalld_zone }}"
    state: enabled
  notify: Reload firewalld

# EPELリポジトリのファイルが存在するか確認
- name: Check if EPEL repository file exists
  ansible.builtin.stat:
    path: /etc/yum.repos.d/epel.repo
  register: epel_repo_file

# 1. EPELリポジトリの設定を変更して、Zabbixパッケージを除外（EPELがある場合のみ）
- name: Ensure EPEL repository excludes Zabbix packages
  ansible.builtin.lineinfile:
    path: /etc/yum.repos.d/epel.repo
    regexp: '^excludepkgs=zabbix\*'
    line: "excludepkgs=zabbix*"
    state: present
  when: epel_repo_file.stat.exists

# 2. Zabbixリポジトリのインストール
- name: Install Zabbix repository
  ansible.builtin.command: rpm -Uvh https://repo.zabbix.com/zabbix/6.0/rhel/9/x86_64/zabbix-release-latest.el9.noarch.rpm
  args:
    creates: /etc/yum.repos.d/zabbix.repo

- name: Import Zabbix GPG key
  ansible.builtin.rpm_key:
    state: present
    key: "https://repo.zabbix.com/RPM-GPG-KEY-ZABBIX-08EFA7DD"

# 4. Zabbix Agent2とプラグインのインストール
- name: Install Zabbix Agent2 and plugins
  ansible.builtin.dnf:
    name:
      - zabbix-agent2
      - zabbix-agent2-plugin-*
    state: present
    enablerepo: zabbix

    ## 5. Zabbix Agent2の再起動と自動起動設定
    #- name: Restart and enable Zabbix Agent2 service
    #  ansible.builtin.systemd:
    #    name: zabbix-agent2
    #    state: restarted
    #    enabled: true

- name: Configure Zabbix Agent2
  ansible.builtin.template:
    src: templates/zabbix_agent2.conf.j2
    dest: /etc/zabbix/zabbix_agent2.conf
    owner: root
    group: root
    mode: "0644"
  notify:
    - Restart Zabbix Agent2
